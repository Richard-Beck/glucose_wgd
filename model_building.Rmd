---
title: "model building"
author: "Richard J Beck"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir="C:/Users/4473331/Documents/projects/006_ploidyModeling/06_ploidy_glucose/glucose_wgd/")
```


```{r}

source("Rscripts/models/model0.R")

x <- readRDS("data/fitting/fit_dat.Rds")
ploidy <- "2N"

glucose <- 5
gname <- "ic_G1_5"

bx <- x$bx1[x$bx1$glucose==glucose&x$bx1$ploidy==ploidy,]
gx <- x$gx1[x$gx1$glucose==glucose&x$gx1$ploidy==ploidy,]

x <- list(bx=bx,gx=gx)

pars<-c(kp=0.5/24,kd=1/24,kbys=0.01,theta=30000,v=0.00001,Gmin=0.05,Gstar=0.1,
        ic_N1=500,ic_G1_0p5=glucose)
names(pars[length(pars)]) <- gname

pars <- unpack_pars(pars)
pars$exp1$glucose <- glucose
y <- run_experiment(par = pars$pars,gs=NULL,ics=pars$exp1,
                       bx=dat$bx1[dat$bx1$ploidy==ploidy,],
                       gx=dat$gx1[dat$gx1$ploidy==ploidy,])

p <- ggplot(x$gx,aes(x=day,y=G))+
  facet_grid(cols=vars(ploidy),rows=vars(glucose),scales="free")+
  geom_point()+
  geom_errorbar(aes(ymin=G-sd,ymax=G+sd))+
  geom_line(data=y$gx)
p

p <- ggplot(x$bx,aes(x=day,y=ncells,color=label))+
  facet_grid(cols=vars(ploidy),rows=vars(glucose),scales="free")+
  geom_point()+
  geom_errorbar(aes(ymin=ncells-sd,ymax=ncells+sd))+
  geom_line(data=y$bx,aes(group=label))
p

```

```{r}
N0 <- 500
G0 <- bx$glucose[1]
y0 <- c(N=N0,D=0,G=G0)

out <- run_mod(pars,times,y0)

ics <- data.frame(N=N0,glucose=G0,G=G0)

wrap_opt <- function(par,gs,ics,bx,gx){
  par <- exp(par)
  err <- err_experiment(par,gs,ics,bx,gx)
  print(err)
}

p0 <- log(pars)
opt <- optim(p0,fn=wrap_opt,gs=NULL,ics=ics,bx=bx,gx=gx)

err_experiment(opt$par,gs=NULL,ics,bx,gx)

```

```{r}

opt_df <- function(par,df){
  par <- exp(par)
  pred <- -par[1]+df$dn*par[2]+df$sn*par[3]
  sum((pred-df$glucose)^2)
}

pred_df <- function(par,df){
  par <- exp(par)
  -par[1]+df$dn*par[2]+df$sn*par[3]
}

summary_df <- function(bxi){
  bxi <- bxi[bxi$label=="alive",]
  bxi <- split(bxi,f=interaction(bxi$ploidy,bxi$glucose))

  df <- do.call(rbind,lapply(bxi,function(bxij){
  dn <- max(bxij$ncells)-bxij$ncells[1]
  sn <- sum(bxij$ncells)
  data.frame(dn,sn,glucose=bxij$glucose[1],ploidy=bxij$ploidy[1])
}))
  df
}
x <- readRDS("data/fitting/fit_dat.Rds")

df1 <- summary_df(x$bx1)
df2 <- summary_df(x$bx2)

Ntrial <- 100

fit <- do.call(rbind,lapply(1:Ntrial,function(i){
  p0 <- exp(-runif(3)*10)
  fit <- optim(p0,fn=opt_df,df=df1)
  c(err=fit$value,fit$par)
}))
print(min(fit[,"err"]))
par <- fit[fit[,"err"]==min(fit[,"err"]),2:4] 
df1$pred <- pred_df(par,df=df1)
df1
```

```{r}



gf <- function(t) return(1/t^2)
mod <- function(Time, State, Pars){
  with(as.list(c(State, Pars)), {
    
    G <- gf(Time)
    dN <- kp*N*(1-N/theta)*1/(1+(g50a/G)^na)-kd*N*(1-1/(1+(g50d/G)^nd))-kd2*N^2/theta
    dD <- kd*N*(1-1/(1+(g50d/G)^nd))+kd2*N^2/theta
    return(list(c(dN,dD)))
  })
}

x <- readRDS("data/fitting/fit_dat.Rds")
gs <- readRDS("data/fitted_parameters/glucose_struct.Rds")
gx <- x$gx2
gx <- gx[gx$ploidy=="2N" & gx$glucose==1,]
gx$G <- gs$qp(gx$lum,q=0.5,gpar = gs$gpar)*gx$dilution

sf <- smooth.spline(gx$day,gx$G,df = 4)





pars<-c(kp=0.1,kd=0.1,kd2=0.01,v1=0.00001,v2=0.00001,theta=10000,g50a=0.2,na=1,g50d=0.01,nd=1)
y <- c(N=500,D=0)
times <- seq(0,7,0.01)
G <- predict(sf,times)
out <- ode(y,times,mod,pars)

plot(G)

plot(out)

```

More thought on the glucose dynamics...

```{r}

xn <- readRDS("data/fitting/fitting_data.Rds")
xn <- xn[sapply(xn,function(yi) !is.null(yi$gx))]
xn <- xn[grepl("4N",names(xn))]
df <- do.call(rbind,lapply(xn,function(xi){
  bx <- xi$bx
na <- bx$ncells[bx$metric=="alive"]
nd <- bx$ncells[bx$metric=="dead"]
ntot <- na+nd
dcells <- max(ntot)-na[1]
na <- cbind(na[-1],na[-length(na)])
ntot <- sum(rowMeans(na) * diff(bx$day[bx$metric=="alive"]))
g <- as.numeric(bx$glucose[1])
data.frame(g,ntot,dcells)  
}))

fit <- lm(g~ntot+dcells,data=df)
df$res <- predict(fit)
fit$coefficients
plot(df$res,df$g)
```

```{r}
pars2N <- readRDS("data/fitted_parameters/init_2N.Rds")
pars4N <- readRDS("data/fitted_parameters/init_4N.Rds")
xn1 <- readRDS("data/raw/221112_ilastik_counts.Rds")
colnames(xn1)[2] <- "metric"
xn2 <- readRDS("data/raw/220823_ilastik_counts.Rds")
colnames(xn2)[2] <- "metric"
xn1$day <- (xn1$frame*8+8)/24
xn2$day <- (xn2$frame*8+8)/24

gx <- readRDS("data/processed/221112_glucose.Rds")

N0 <- 700

outn1 <- do.call(rbind,lapply(unique(xn1$glucose),function(gi){
  rbind(run_mod(pars=pars2N,ploidy="2N",gluconc=gi,N0=550),
        run_mod(pars=pars4N,ploidy="4N",gluconc=gi,N0=500))
  
}))
outn2 <- do.call(rbind,lapply(unique(xn2$glucose),function(gi){
  rbind(run_mod(pars=pars2N,ploidy="2N",gluconc=gi,N0=750),
        run_mod(pars=pars4N,ploidy="4N",gluconc=gi,N0=675))
  
}))


pn1 <- ggplot(xn1,aes(x=day,y=ncells,color=metric))+
  facet_grid(rows=vars(glucose),cols=vars(ploidy),scales="free")+
  geom_point()+
  geom_line(data=outn1)+
  scale_color_discrete("")+
  scale_x_continuous("days")+
  scale_y_continuous("number of cells")+
  theme_classic(base_size = 16)+
  theme(legend.position = "top")
pn1

pn2 <- ggplot(xn2,aes(x=day,y=ncells,color=metric))+
  facet_grid(rows=vars(glucose),cols=vars(ploidy),scales="free")+
  geom_point()+
  geom_line(data=outn2)+
  scale_color_discrete("")+
  scale_x_continuous("days")+
  scale_y_continuous("number of cells")+
  theme_classic(base_size = 16)+
  theme(legend.position = "top")
pn2

pg <- ggplot(gx,aes(x=day,y=G))+
  facet_grid(cols=vars(ploidy),rows=vars(glucose),scales="free")+
  geom_point()+
  geom_line(data=outn1)+
  geom_line(data=outn2)
pg

```