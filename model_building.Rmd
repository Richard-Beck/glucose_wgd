---
title: "model building"
author: "Richard J Beck"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir="C:/Users/4473331/Documents/projects/006_ploidyModeling/06_ploidy_glucose/glucose_wgd/")
```


```{r}


est_dcells <- function(xx,celltype="alive"){
  xx$bx <- xx$bx[xx$bx$metric==celltype,]
  dn <- diff(xx$bx$ncells)
  dn <- c(NaN,zoo::rollmean(dn,k=2),NaN)
  xx$bx$dn <- dn/diff(xx$bx$day)[1]
  merge(xx$bx,xx$gx,by=c("day","ploidy","glucose"))
}

get_dg <- function(xx){
  
  xx$gx <- xx$gx[order(xx$gx$day),]
  xx$gx$backdiff <- c(NaN,diff(xx$gx$G))
  xx$gx$fordiff <- c(diff(xx$gx$G),NaN)
  return(xx)
}

mm <- function(pars,dat){
    rmax <- pars[1]
    g50 <- pars[2]
    n <- pars[3]
    est <- rmax*(1-dat$G^n/(dat$G^n+g50^n))
    if(dat$variable[1]=="da") est <-  rmax*(dat$G^n/(dat$G^n+g50^n))
    return(est)
}

fit_mm <- function(pars,dat){
  rmax <- pars[1]
  g50 <- pars[2]
  n <- pars[3]
  est <- rmax*(1-dat$G^n/(dat$G^n+g50^n))
  if(dat$variable[1]=="da") est <-  rmax*(dat$G^n/(dat$G^n+g50^n))
  sum((est-dat$value)^2)
}

mmg <- function(pars,mg){
  n <- pars[2]
  g50 <- pars[3]
  res <- pars[1]*mg$ncells*mg$G^n/(mg$G^n+g50^n)
  res
}
fit_mmg <- function(pars,mg){
  res <- mmg(pars,mg)
  sum((res-mg$dG))^2
}


xn <- readRDS("data/fitting/fitting_data.Rds")
has_glucose <- sapply(xn,function(xni) !is.null(xni$gx))
xn <- xn[has_glucose]
xn <- lapply(xn,get_dg)

mg <- do.call(rbind,lapply(xn,function(xni){
  merge(xni$bx,xni$gx,by=c("day","ploidy","glucose"))
}))
mg$dG <- apply(mg[,c("backdiff","fordiff")],1,mean,na.rm=T)

mg2 <- mg[mg$metric=="alive" & mg$ploidy=="2N",]
mg2$nG <- mg2$G*mg2$ncells
mg4 <- mg[mg$metric=="alive" & mg$ploidy=="4N",]
mg4$nG <- mg4$G*mg4$ncells

pars <- c(0.001,1,0.01)

fmg2 <- optim(pars,fit_mmg,mg=mg2)
fmg4 <- optim(pars,fit_mmg,mg=mg4)

pars2N <- fmg2$par
names(pars2N) <- c("kg","ng","g50c")
pars4N <- fmg4$par
names(pars4N) <- c("kg","ng","g50c")

mg2$pred <- mmg(fmg2$par,mg2)
mg4$pred <- mmg(fmg4$par,mg4)

dfg <- rbind(mg2,mg4)


p <- ggplot(dfg,aes(x=nG,y=-dG))+
  facet_grid(cols=vars(ploidy))+
  geom_point()+
  scale_x_continuous("ncells*Glucose")+
  scale_y_continuous("glucose uptake")
p

xa <- do.call(rbind,lapply(xn,est_dcells,celltype="alive"))
xd <- do.call(rbind,lapply(xn,est_dcells,celltype="dead"))

if(mean(xa$G!=xd$G)) stop("out of expected order!")

dd <- xd$dn/xa$ncells
da <- (xa$dn+xd$dn)/xa$ncells

x <- xa
x$da <- da
x$dd <- dd


x <- reshape2::melt(x,measure.vars=c("dd","da"))
p <- ggplot(x,aes(x=G,y=value,color=variable))+
  facet_grid(cols=vars(ploidy))+
  geom_point()+
  scale_x_log10()
p


pars <- c(0.5,0.01,5)

x <- split(x,f=interaction(x$variable,x$ploidy))

xpar <- lapply(x,function(xi){
  optim(pars,fit_mm,dat=xi)$par
})

xpar2N <- c(xpar[[1]],xpar[[2]])
names(xpar2N) <- c("kd","g50d","nd","ka","g50a","na")
xpar4N <- c(xpar[[3]],xpar[[4]])
names(xpar4N) <- c("kd","g50d","nd","ka","g50a","na")

pars2N <- c(pars2N,xpar2N)
pars4N <- c(pars4N,xpar4N)

xfit <- do.call(rbind,lapply(1:length(x),function(i){
  pars <- xpar[[i]]
  df <- x[[i]]
  df$pred <- mm(pars,df)
  df
}))

xpar <- data.frame(do.call(rbind,xpar))
xpar <- cbind(xpar,do.call(rbind,lapply(rownames(xpar),function(ii){
  unlist(strsplit(ii,split="[.]"))
})))
colnames(xpar) <- c("rmax","g50","n","celltype","ploidy")
xpar <- reshape2::melt(xpar,id.vars=c("celltype","ploidy"))

p <- ggplot(xpar,aes(x=ploidy,y=value))+
  facet_grid(rows=vars(variable),cols=vars(celltype),scales="free")+
  geom_col()
p

renamr <- c(dd="death",da="growth")
xfit$variable <- renamr[xfit$variable]
p <- ggplot(xfit,aes(x=G,y=value,color=ploidy))+
  facet_grid(cols=vars(variable))+
  geom_point()+
  geom_line(aes(y=pred))+
  scale_x_log10("glucose (mM)")+
  scale_y_continuous("growth/death rate")
p
saveRDS(pars2N,"data/fitted_parameters/init_2N.Rds")
saveRDS(pars4N,"data/fitted_parameters/init_4N.Rds")
```




```{r}
delay <- 1
mod <- function(Time, State, Pars){
  with(as.list(c(State, Pars)), {
        # Get the delayed glucose concentration
    if (Time > delay) {
      G_delayed <- lagvalue(Time - delay, 3)
    } else {
      G_delayed <- 25  # If the time is less than the delay, use the initial value
    }
    
    dN <- ka*N/(1+(g50a/G)^na)-kd*N*(1-1/(1+(g50d/G_delayed)^nd))
    dD <- kd*N*(1-1/(1+(g50d/G)^nd))
    dG <- kg*N*G^ng/(G^ng+g50c^ng)
    return(list(c(dN,dD,dG)))
  })
}

y <- c(N=500,D=0,G=0)
times <- seq(0,7,0.01)
out <- dede(y,times,mod,pars2N)

plot(out)


run_mod <- function(pars,ploidy,gluconc,N0){
  y <- c(N=N0,D=0,G=gluconc)
  times <- seq(0,7,0.01)
  out <- data.frame(ode(y,times,mod,pars))
  colnames(out) <- c("day","alive","dead","G")
  out <- reshape2::melt(out,id.vars=c("day","G"))
  colnames(out)[3:4] <- c("metric","ncells")
  out$ploidy <- ploidy
  out$glucose <- gluconc
  out
  
}

```

More thought on the glucose dynamics...

```{r}

xn <- readRDS("data/fitting/fitting_data.Rds")
xn <- xn[sapply(xn,function(yi) !is.null(yi$gx))]
xn <- xn[grepl("4N",names(xn))]
df <- do.call(rbind,lapply(xn,function(xi){
  bx <- xi$bx
na <- bx$ncells[bx$metric=="alive"]
nd <- bx$ncells[bx$metric=="dead"]
ntot <- na+nd
dcells <- max(ntot)-na[1]
na <- cbind(na[-1],na[-length(na)])
ntot <- sum(rowMeans(na) * diff(bx$day[bx$metric=="alive"]))
g <- as.numeric(bx$glucose[1])
data.frame(g,ntot,dcells)  
}))

fit <- lm(g~ntot+dcells,data=df)
df$res <- predict(fit)
fit$coefficients
plot(df$res,df$g)
```

```{r}
pars2N <- readRDS("data/fitted_parameters/init_2N.Rds")
pars4N <- readRDS("data/fitted_parameters/init_4N.Rds")
xn1 <- readRDS("data/raw/221112_ilastik_counts.Rds")
colnames(xn1)[2] <- "metric"
xn2 <- readRDS("data/raw/220823_ilastik_counts.Rds")
colnames(xn2)[2] <- "metric"
xn1$day <- (xn1$frame*8+8)/24
xn2$day <- (xn2$frame*8+8)/24

gx <- readRDS("data/processed/221112_glucose.Rds")

N0 <- 700

outn1 <- do.call(rbind,lapply(unique(xn1$glucose),function(gi){
  rbind(run_mod(pars=pars2N,ploidy="2N",gluconc=gi,N0=550),
        run_mod(pars=pars4N,ploidy="4N",gluconc=gi,N0=500))
  
}))
outn2 <- do.call(rbind,lapply(unique(xn2$glucose),function(gi){
  rbind(run_mod(pars=pars2N,ploidy="2N",gluconc=gi,N0=750),
        run_mod(pars=pars4N,ploidy="4N",gluconc=gi,N0=675))
  
}))


pn1 <- ggplot(xn1,aes(x=day,y=ncells,color=metric))+
  facet_grid(rows=vars(glucose),cols=vars(ploidy),scales="free")+
  geom_point()+
  geom_line(data=outn1)+
  scale_color_discrete("")+
  scale_x_continuous("days")+
  scale_y_continuous("number of cells")+
  theme_classic(base_size = 16)+
  theme(legend.position = "top")
pn1

pn2 <- ggplot(xn2,aes(x=day,y=ncells,color=metric))+
  facet_grid(rows=vars(glucose),cols=vars(ploidy),scales="free")+
  geom_point()+
  geom_line(data=outn2)+
  scale_color_discrete("")+
  scale_x_continuous("days")+
  scale_y_continuous("number of cells")+
  theme_classic(base_size = 16)+
  theme(legend.position = "top")
pn2

pg <- ggplot(gx,aes(x=day,y=G))+
  facet_grid(cols=vars(ploidy),rows=vars(glucose),scales="free")+
  geom_point()+
  geom_line(data=outn1)+
  geom_line(data=outn2)
pg

```